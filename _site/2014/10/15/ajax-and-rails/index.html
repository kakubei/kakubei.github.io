<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Ajax and Rails, making it work &middot; Kakuweb Blog
    
  </title>


    <!-- This is a header with the pages_list array declared in config.yml -->
<!--
    <h3 class="masthead-title">
    <a href="/" title="Home">Kakuweb Blog</a>

    
    </h3>
-->

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="theme-base-08 layout-reverse">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>Hodgepodge bunch of stuff, mostly related to programming but really anything I feel like ranting about.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/archive/">Posts</a>
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/novel/">My Novel</a>
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    


  <!-- listing the latest 10 entries -->
    <section>
        <span class="sidebar-nav-item">Recent Posts</span>
        <ul>
        
          <li>
            <a href="/2017/01/19/buying-a-new-videogame/">The sure-fire way to buy a new video game</a>
          </li>
        
          <li>
            <a href="/2017/01/15/back-to-work/">Back to work</a>
          </li>
        
          <li>
            <a href="/2017/01/14/move-to-london/">So you want to move to London</a>
          </li>
        
          <li>
            <a href="/2016/02/24/Tap-Gesture-and-TableView/">Using a Tap Gesture That Doesn't Interfere with a TableView in iOS</a>
          </li>
        
          <li>
            <a href="/2016/02/24/Close-iOS-Keyboard/">Best Way to Close the iOS Keyboard</a>
          </li>
        
          <li>
            <a href="/2016/02/05/Apple-Music-HipHop/">Apple Radio = The HipHop Channel</a>
          </li>
        
          <li>
            <a href="/2016/02/04/Bicycle-Wheel-Sizes/">Bicycle Wheel Sizes</a>
          </li>
        
          <li>
            <a href="/2015/08/19/Swift-is-cool/">Swift is Actually Cool!</a>
          </li>
        
          <li>
            <a href="/2015/08/19/Apple-Watch-is-a-gimmick/">The Apple Watch is a Gimmick</a>
          </li>
        
          <li>
            <a href="/2015/06/05/Irony-of-To-Do-Apps/">The Irony of To Do Apps</a>
          </li>
        
        </ul>
    </section>

    <span class="sidebar-nav-item">Currently v0.7</span>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2017. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Kakuweb Blog</a>
            <small>Rants and raves. Some interesting stuff, most of it not.</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Ajax and Rails, making it work</h1>
  <span class="post-date">15 Oct 2014</span>
  <p>Every time I need to add some Ajax to a Rails project I need to look up documentation and search through all my earlier files to see how I did it. Maybe this is because I’m old and was doing javascript (which I hate BTW) the old-fashioned way so getting my head around the Rails way might be more difficult, I don’t know, but it’s a pain in the arse, so I’m writing a little blog post so I can refer to it and hopefully it’ll help other people too.</p>

<h2 id="how-it-works">How it works</h2>
<p>To me, Ajax in Rails is needlessly convoluted, but here’s how it works:</p>

<ol>
  <li>You create a link with <code class="highlighter-rouge">link_to</code> and set the <code class="highlighter-rouge">remote</code> option to <code class="highlighter-rouge">true</code></li>
  <li>In your controller, for that link, create a <code class="highlighter-rouge">format.js</code> response</li>
  <li>Create a javascript file with the same name as the method the link responds to</li>
  <li>In that javascript file, put the <code class="highlighter-rouge">js</code> code you want Rails to execute when you click the link</li>
</ol>

<h3 id="example">Example</h3>
<p>This is a simple issue where I need to hide or show a column based on the value of a cookie which I’ve previously put into an instance variable:</p>

<p>The link</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># 1</span>
<span class="o">=</span> <span class="n">link_to</span> <span class="s2">"&lt;span class='btn btn-sm btn-primary'&gt;eye-icon&lt;/span&gt;"</span><span class="p">.</span><span class="nf">html_safe</span><span class="p">,</span> <span class="n">users_flip_show_dogtag_path</span><span class="p">,</span> <span class="ss">title: </span><span class="n">icon_title</span><span class="p">,</span> <span class="ss">remote: </span><span class="kp">true</span></code></pre></figure>

<p>The controller method</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># 2</span>
<span class="k">def</span> <span class="nf">flip_show_dogtag</span>
   <span class="k">if</span> <span class="n">cookies</span><span class="p">[</span><span class="ss">:show_library_dogtags</span><span class="p">].</span><span class="nf">to_i</span> <span class="o">==</span> <span class="mi">1</span>
     <span class="n">set_dogtag_to</span> <span class="o">=</span> <span class="s1">'0'</span>
   <span class="k">else</span>
     <span class="n">set_dogtag_to</span> <span class="o">=</span> <span class="s1">'1'</span>
   <span class="k">end</span>
   <span class="n">cookies</span><span class="p">.</span><span class="nf">permanent</span><span class="p">[</span><span class="ss">:show_library_dogtags</span><span class="p">]</span> <span class="o">=</span> <span class="n">set_dogtag_to</span>
   <span class="vi">@dogtag_show_value</span> <span class="o">=</span> <span class="n">set_dogtag_to</span> <span class="c1"># we'll use this in the views</span>
 
   <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
     <span class="nb">format</span><span class="p">.</span><span class="nf">js</span>
   <span class="k">end</span>
 <span class="k">end</span></code></pre></figure>

<p>The javascript file</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// 3</span>
<span class="k">if</span> <span class="p">(</span><span class="s2">"&lt;%=j @dogtag_show_value %&gt;"</span> <span class="o">==</span> <span class="s1">'1'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">'.dogTag'</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">'.dogTag'</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
 <span class="p">}</span>
 <span class="c1">// this last line simply refreshes the header with the icons which also change based on the cookie state</span>
 <span class="nx">$</span><span class="p">(</span><span class="s1">'.collection-flip-switch'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">"&lt;%=j render 'layouts/flip_collection_state' %&gt;"</span><span class="p">);</span></code></pre></figure>

<h2 id="pitfalls">Pitfalls</h2>
<p>Beware of comparing integer values inside <code class="highlighter-rouge">js.erb</code> files, you might get a <strong>missing method error</strong> when the javascript helper tries to run <code class="highlighter-rouge">gsub</code> on the integer:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">    <span class="no">NoMethodError</span> <span class="o">-</span> <span class="n">undefined</span> <span class="nb">method</span> <span class="s1">'gsub'</span> <span class="k">for</span> <span class="mi">0</span><span class="ss">:Fixnum</span><span class="p">:</span>
       <span class="n">actionpack</span> <span class="p">(</span><span class="mi">4</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">4</span><span class="p">)</span> <span class="n">lib</span><span class="o">/</span><span class="n">action_view</span><span class="o">/</span><span class="n">helpers</span><span class="o">/</span><span class="n">javascript_helper</span><span class="p">.</span><span class="nf">rb</span><span class="p">:</span><span class="mi">27</span><span class="ss">:in</span> <span class="s1">'escape_javascript'</span></code></pre></figure>

<p>This sucks because it means you can’t use integers for anything you need to then equate in a <code class="highlighter-rouge">js.erb</code> file but I don’t know of a workaround.</p>

<h2 id="reloading-a-dom-element">Reloading a DOM element</h2>
<p>If you want to reload part of the page, it gets even more convoluted because you need to create a Rails template that you can call to render only that portion. Rails calls this the ‘unobtrusive’ way, but it really fragments your views and you end up with as much as 5 files to edit just to get this to work, let’s count them:</p>

<ol>
  <li>the <code class="highlighter-rouge">routes</code> file, you’ll need to add a route for the link</li>
  <li>the <code class="highlighter-rouge">controller</code> file that the link method calls</li>
  <li>the <code class="highlighter-rouge">view</code> file that shows your data</li>
  <li>the <code class="highlighter-rouge">js.erb</code> (or <code class="highlighter-rouge">coffescript</code>) file that contains the actual javascript code</li>
  <li>the <code class="highlighter-rouge">Rails partial</code> file that you want to refresh</li>
</ol>

<p>Not what I would call unobtrusive at all but there you go.</p>

<p>So in our earlier example, lets refresh part of the page.</p>

<h3 id="refreshing-part-of-the-page">Refreshing part of the page</h3>
<p>All of the above stays the same, but we need 2 things to make the refresh happen:</p>

<ol>
  <li>an <code class="highlighter-rouge">element</code> that we will refresh</li>
  <li>the <code class="highlighter-rouge">Rails partial</code> that will contain the data that we will <em>reload</em></li>
</ol>

<p>In our view file we create an element (generally a div) that we will refresh, it might look like this:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># 1</span>
<span class="p">.</span><span class="nf">collection</span><span class="o">-</span><span class="n">flip</span><span class="o">-</span><span class="n">switch</span>
  <span class="o">=</span> <span class="n">render</span> <span class="s1">'layouts/flip_collection_state'</span></code></pre></figure>

<p>The Rails partial</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">-</span> <span class="k">if</span> <span class="n">cookies</span><span class="p">[</span><span class="ss">:show_library_dogtags</span><span class="p">].</span><span class="nf">to_i</span> <span class="o">==</span> <span class="mi">1</span>
   <span class="o">-</span> <span class="n">dogtag_icon</span> <span class="o">=</span> <span class="s2">"&lt;i class='icon-eye-open'&gt;&lt;/i&gt;"</span>
 <span class="o">-</span><span class="k">else</span>
   <span class="o">-</span> <span class="n">dogtag_icon</span> <span class="o">=</span> <span class="s2">"&lt;i class='icon-eye-close'&gt;&lt;/i&gt;"</span>
 
<span class="o">=</span> <span class="n">link_to</span> <span class="s2">"&lt;span class='btn btn-sm btn-primary'&gt;</span><span class="si">#{</span><span class="n">dogtag_icon</span><span class="si">}</span><span class="s2">&lt;/span&gt;"</span><span class="p">.</span><span class="nf">html_safe</span><span class="p">,</span> <span class="n">users_flip_show_dogtag_path</span><span class="p">,</span> <span class="ss">title: </span><span class="n">icon_title</span><span class="p">,</span> <span class="ss">remote: </span><span class="kp">true</span></code></pre></figure>

<p>The bit in the <code class="highlighter-rouge">js.erb</code> that actually refreshes the DOM element:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">$</span><span class="p">(</span><span class="s1">'.collection-flip-switch'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">"&lt;%=j render 'layouts/flip_collection_state' %&gt;"</span><span class="p">);</span></code></pre></figure>

<p>In this case the partial only contains a link and the logic to represent the right icon depending on a cookie value (I’ve stripped some other code that also gets refreshed to keep things simple).</p>

<h2 id="conclusion">Conclusion</h2>
<p>So, not very unobtrusive at all and too many moving parts to remember every time.</p>

<p>Feel free to refer to this nifty guide the next time you need to use Ajax in Rails, I know I will :)</p>

</div>

<img src="/images/twitter_logo_blue.png" alt="Twitter" style="width: 30px; float: left; margin-right: 10px;">
<a href="https://twitter.com/intent/tweet?url=http://localhost:4000/2014/10/15/ajax-and-rails/&text=Ajax and Rails, making it work&via=kakubei"
   target="_blank">Share this post </a>if you want,
or
<a href="https://twitter.com/kakubei">
  follow me on Twitter</a> if you're into that stuff.

<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'noirnovel'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>


<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2017/01/19/buying-a-new-videogame/">
            The sure-fire way to buy a new video game
            <small>19 Jan 2017</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2017/01/15/back-to-work/">
            Back to work
            <small>15 Jan 2017</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2017/01/14/move-to-london/">
            So you want to move to London
            <small>14 Jan 2017</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-50242492-1', 'kakubei.github.io');
  ga('require', 'displayfeatures');
  ga('send', 'pageview');

</script>


  </body>
</html>
