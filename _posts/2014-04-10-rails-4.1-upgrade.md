---
layout: post
title: "Rails 4.1 upgrade"
description: ""
tags: []
---

**[Rails 4.1](http://edgeguides.rubyonrails.org/4_1_release_notes.html) is out** and it has some very nice changes, enough to want to make you upgrade immediately, but beware of some issues:

* Issues with [Squeel](https://github.com/activerecord-hackery/squeel)
* [Zeus](https://github.com/burke/zeus) vs [Spring](https://github.com/rails/spring/blob/master/README.md)
* [sidekiq](https://github.com/mperham/sidekiq)


### Squeel
Rails 4.1 and Active Record have a lot of issues with `Squeel`, and by that I mean that your app will fail to load until you've put this into your `Gemfile`:

    gem 'polyamorous', github: 'activerecord-hackery/polyamorous'

You'll see an error like this:

    undefined method `graft' for class `ActiveRecord::Associations::JoinDependency' (NameError)

If the above gem doesn't clear it, put this in as well:

    gem 'activeadmin', github: 'gregbell/active_admin'

The tough thing is that there is very little indication that it is Squeel that is causing the error so it's hard to track. I love Squeel, I use it on all my Rails and Padrino apps, but that's the problem with gems that `hack` other gems, things can get hairy.

Ernie Miller, the guy who created Squeel, has moved all of gems into a new github repository appropriately called [activerecord-hackery](https://github.com/activerecord-hackery), you might find some more info there, the bad news is he is not maintaining them anymore, so we'll have to wait and see if other developers take over the job or we'll be forced to remove Squeel from all our projects or not upgrade past a certain point.

### Sidekiq
Sidekiq has also made a number of changes under the hood in version 3.0.0. We have 2 projects using it and I had to revert to version 2.17.4 because upgrading would require a number of rewrites to our code which I'm not ready for yet, they don't seem to be huge changes, but after fighting with Sidekiq for a while in our production app (since the errors did not show up in Development) I gave up for the time being and will address them down the line.

The upgrade read me is [here](https://github.com/mperham/sidekiq/blob/master/3.0-Upgrade.md)

I had 2 errors, the first one was easy to fix:

    NameError: uninitialized constant Sidekiq::Stats;

Just put this at the top of the file that calls Sidekiq:

    require 'sidekiq/api'

This wasn't required in version 2.17.4 so it's a bit weird, but hey that fixed it.

The second error:

    ArgumentError - wrong number of arguments (4 for 3):
    # for this line
    call(worker_instance, msg, queue)

It turns out that:

> 3rd party gems which use client-side middleware will need to update due to an API change. The Redis connection for a particular job is passed thru the middleware to handle sharding where jobs can be pushed to different redis server instances.

And you're now supposed to do something like:

    call(worker_instance, msg, queue, redis_pool)

Again, not a huge change, but it does require some rewrites, and those are the 2 I found, there's no guarantee that if I fix those others won't crop up.

### Zeus vs Spring
These are both preloading libraries to make your Rails faster and your life better. Zeus has been around for a while and it's great, it's even integrated into Rubymine which is awesome. So what's the issue? you ask just stick with Zeus. I am but Spring is now integrated into Rails 4.1 by default and it's always nice to be able to use out of the box solutions, especially ones built by people smarter than you.

If using Rubymine, just make sure to use version `0.13.4-pre2` of Zeus.

    gem 'zeus', '0.13.4.pre2'

This last one is not really and issue since it's only applicable in a development environment but you should be aware of it so you don't run into problem when upgrading. Pick one of the two and stick with it.

### Procrastination conclusion

At this point, I'm trying to solve other issues and while I'd love to upgrade to Rails 4.1 I just don't have the time to fight with all these different issues.
